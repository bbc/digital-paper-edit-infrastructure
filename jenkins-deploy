#!/bin/sh
set -eu

DIR=$1
ENV=$2

cd dpe-$DIR

npm install bbc/cosmos-deploy#v3

node_modules/.bin/cosmos-deploy update-repositories digital-paper-edit-$DIR $ENV 1.0.0
node_modules/.bin/cosmos-deploy update-config digital-paper-edit-$DIR $ENV 1.0.0 || echo "No config files"
node_modules/.bin/cosmos-deploy provision-stack digital-paper-edit-$DIR $ENV 1.0.0 dns
node_modules/.bin/cosmos-deploy provision-stack digital-paper-edit-$DIR $ENV 1.0.0 main
node_modules/.bin/cosmos-deploy provision-stack digital-paper-edit-$DIR $ENV 1.0.0 monitoring || echo "Couldn't create log stack"; 

if [ $DIR = "stt-proxy" ] || [ $DIR = "audio-converter" ] ; then
    node_modules/.bin/cosmos-deploy provision-stack digital-paper-edit-$DIR $ENV 1.0.0 queue;
    node_modules/.bin/cosmos-deploy provision-stack digital-paper-edit-$DIR $ENV 1.0.0 s3 
elif [ $DIR = "api" ] || [ $DIR = "api" ] ; then
    node_modules/.bin/cosmos-deploy provision-stack digital-paper-edit-$DIR $ENV 1.0.0 rds;
else
	echo "No other stacks to provision"
fi
